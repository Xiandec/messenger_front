# Документация API для мессенджера

## Основная информация

- **Базовый URL**: `/api/v1`
- **Формат данных**: JSON
- **Кодировка**: UTF-8

## Аутентификация

Система использует аутентификацию на основе JWT токенов. Все защищенные эндпоинты требуют наличия Bearer-токена в заголовке.

### Процесс аутентификации

1. Пользователь регистрируется через `/api/v1/auth/register`
2. Пользователь получает токен через `/api/v1/auth/token`
3. Для доступа к защищенным эндпоинтам необходимо добавить заголовок:
   ```
   Authorization: Bearer {полученный_токен}
   ```

### Параметры JWT токена

- **Алгоритм**: HS256
- **Срок действия**: 30 минут
- **Данные токена**: содержит ID пользователя в поле `sub`

## Эндпоинты

### Авторизация

#### Регистрация нового пользователя

- **URL**: `/api/v1/auth/register`
- **Метод**: POST
- **Авторизация**: Не требуется
- **Тело запроса**:
  ```json
  {
    "email": "user@example.com",
    "name": "Имя пользователя",
    "password": "пароль"
  }
  ```
- **Ответ** (200 OK):
  ```json
  {
    "id": "uuid-пользователя",
    "email": "user@example.com",
    "name": "Имя пользователя"
  }
  ```
- **Ошибка** (400 Bad Request):
  ```json
  {
    "detail": "Пользователь с таким email уже существует"
  }
  ```

#### Получение токена доступа

- **URL**: `/api/v1/auth/token`
- **Метод**: POST
- **Авторизация**: Не требуется
- **Тело запроса**:
  ```json
  {
    "email": "user@example.com",
    "password": "пароль"
  }
  ```
- **Ответ** (200 OK):
  ```json
  {
    "access_token": "jwt-токен",
    "token_type": "bearer",
    "user_id": "uuid-пользователя",
    "name": "Имя пользователя"
  }
  ```
- **Ошибка** (401 Unauthorized):
  ```json
  {
    "detail": "Неверный email или пароль"
  }
  ```

### Чаты

#### Создание личного чата

- **URL**: `/api/v1/chats/personal`
- **Метод**: POST
- **Авторизация**: Требуется (Bearer токен)
- **Тело запроса**:
  ```json
  {
    "type": "personal",
    "member_ids": ["uuid-пользователя-собеседника"]
  }
  ```
- **Ответ** (200 OK):
  ```json
  {
    "id": "uuid-чата",
    "name": null,
    "type": "personal",
    "members": [
      {
        "id": "uuid-пользователя-1",
        "email": "user1@example.com",
        "name": "Имя пользователя 1"
      },
      {
        "id": "uuid-пользователя-2",
        "email": "user2@example.com",
        "name": "Имя пользователя 2"
      }
    ]
  }
  ```
- **Ошибка** (400 Bad Request):
  ```json
  {
    "detail": "Ошибка при создании чата"
  }
  ```

#### Создание группового чата

- **URL**: `/api/v1/chats/group`
- **Метод**: POST
- **Авторизация**: Требуется (Bearer токен)
- **Тело запроса**:
  ```json
  {
    "name": "Название группового чата",
    "type": "group",
    "member_ids": ["uuid-пользователя-1", "uuid-пользователя-2", ...]
  }
  ```
- **Ответ** (200 OK):
  ```json
  {
    "id": "uuid-чата",
    "name": "Название группового чата",
    "type": "group",
    "members": [
      {
        "id": "uuid-пользователя-1",
        "email": "user1@example.com",
        "name": "Имя пользователя 1"
      },
      {
        "id": "uuid-пользователя-2",
        "email": "user2@example.com",
        "name": "Имя пользователя 2"
      },
      ...
    ]
  }
  ```
- **Ошибка** (400 Bad Request):
  ```json
  {
    "detail": "Ошибка при создании группового чата"
  }
  ```

#### Получение списка чатов пользователя

- **URL**: `/api/v1/chats`
- **Метод**: GET
- **Авторизация**: Требуется (Bearer токен)
- **Ответ** (200 OK):
  ```json
  [
    {
      "id": "uuid-чата-1",
      "name": "Название чата 1",
      "type": "personal",
      "members": [...]
    },
    {
      "id": "uuid-чата-2",
      "name": "Название чата 2",
      "type": "group",
      "members": [...]
    },
    ...
  ]
  ```

#### Получение списка чатов пользователя с последними сообщениями

- **URL**: `/api/v1/chats/with-last-message`
- **Метод**: GET
- **Авторизация**: Требуется (Bearer токен)
- **Ответ** (200 OK):
  ```json
  [
    {
      "id": "uuid-чата-1",
      "name": "Название чата 1",
      "type": "personal",
      "members": [...],
      "last_message": {
        "id": "uuid-сообщения",
        "sender_id": "uuid-отправителя",
        "sender_name": "Имя отправителя",
        "text": "Текст последнего сообщения",
        "timestamp": "2023-06-21T14:30:00.123456",
        "is_read": false
      },
      "unread_count": 5
    },
    {
      "id": "uuid-чата-2",
      "name": "Название чата 2",
      "type": "group",
      "members": [...],
      "last_message": {
        "id": "uuid-сообщения",
        "sender_id": "uuid-отправителя",
        "sender_name": "Имя отправителя",
        "text": "Текст последнего сообщения",
        "timestamp": "2023-06-21T14:30:00.123456",
        "is_read": true
      },
      "unread_count": 0
    },
    ...
  ]
  ```

#### Получение информации о чате по ID

- **URL**: `/api/v1/chats/{chat_id}`
- **Метод**: GET
- **Авторизация**: Требуется (Bearer токен)
- **Параметры пути**:
  - `chat_id`: UUID чата
- **Ответ** (200 OK):
  ```json
  {
    "id": "uuid-чата",
    "name": "Название чата",
    "type": "personal|group",
    "members": [...]
  }
  ```
- **Ошибка** (404 Not Found):
  ```json
  {
    "detail": "Чат не найден"
  }
  ```
- **Ошибка** (403 Forbidden):
  ```json
  {
    "detail": "Доступ запрещен"
  }
  ```

### Сообщения

#### Получение истории чата

- **URL**: `/api/v1/chats/{chat_id}/history`
- **Метод**: GET
- **Авторизация**: Требуется (Bearer токен)
- **Параметры пути**:
  - `chat_id`: UUID чата
- **Параметры запроса**:
  - `limit`: количество сообщений (по умолчанию 100)
  - `offset`: смещение для пагинации (по умолчанию 0)
- **Ответ** (200 OK):
  ```json
  {
    "messages": [
      {
        "id": "uuid-сообщения",
        "chat_id": "uuid-чата",
        "sender_id": "uuid-отправителя",
        "sender": {
          "id": "uuid-отправителя",
          "email": "sender@example.com",
          "name": "Имя отправителя"
        },
        "text": "Текст сообщения",
        "timestamp": "2023-06-21T14:30:00.123456",
        "is_read": true
      },
      ...
    ],
    "total": 150
  }
  ```
- **Ошибка** (400 Bad Request):
  ```json
  {
    "detail": "Ошибка при получении истории чата"
  }
  ```

#### Отправка нового сообщения

- **URL**: `/api/v1/chats/messages`
- **Метод**: POST
- **Авторизация**: Требуется (Bearer токен)
- **Тело запроса**:
  ```json
  {
    "chat_id": "uuid-чата",
    "text": "Текст сообщения"
  }
  ```
- **Ответ** (200 OK):
  ```json
  {
    "id": "uuid-сообщения",
    "chat_id": "uuid-чата",
    "sender_id": "uuid-отправителя",
    "sender": {
      "id": "uuid-отправителя",
      "email": "sender@example.com",
      "name": "Имя отправителя"
    },
    "text": "Текст сообщения",
    "timestamp": "2023-06-21T14:30:00.123456",
    "is_read": false
  }
  ```
- **Ошибка** (400 Bad Request):
  ```json
  {
    "detail": "Ошибка при отправке сообщения"
  }
  ```

#### Пометить сообщение как прочитанное

- **URL**: `/api/v1/chats/messages/{message_id}/read`
- **Метод**: POST
- **Авторизация**: Требуется (Bearer токен)
- **Параметры пути**:
  - `message_id`: UUID сообщения
- **Ответ** (200 OK):
  ```json
  {
    "message_id": "uuid-сообщения",
    "is_read": true
  }
  ```
- **Ошибка** (400 Bad Request):
  ```json
  {
    "detail": "Ошибка при отметке сообщения как прочитанного"
  }
  ```

## WebSocket API

WebSocket API используется для обмена сообщениями в реальном времени.

### Подключение к чату

- **URL**: `/ws/{chat_id}?token={jwt-токен}`
- **Параметры пути**:
  - `chat_id`: UUID чата
- **Параметры запроса**:
  - `token`: JWT токен аутентификации (тот же, что используется для HTTP API)

### Подключение к глобальному эндпоинту пользователя

- **URL**: `/ws/user?token={jwt-токен}`
- **Параметры запроса**:
  - `token`: JWT токен аутентификации (тот же, что используется для HTTP API)
- **Описание**: Этот эндпоинт позволяет подключиться к вебсокету, который будет возвращать уведомления о новых сообщениях из всех чатов пользователя. Идеально подходит для обновления UI с уведомлениями в реальном времени.

### Процесс подключения к чату

1. Клиент открывает WebSocket соединение
2. Сервер проверяет токен и доступ к чату
3. При успешной авторизации сервер отправляет подтверждение подключения:
   ```json
   {
     "status": "connected",
     "user_id": "uuid-пользователя",
     "chat_id": "uuid-чата"
   }
   ```
4. При ошибке авторизации сервер отправляет сообщение об ошибке и закрывает соединение:
   ```json
   {
     "error": "Недействительный токен"
   }
   ```
   или
   ```json
   {
     "error": "Чат не найден или доступ запрещен"
   }
   ```

### Процесс подключения к глобальному эндпоинту пользователя

1. Клиент открывает WebSocket соединение
2. Сервер проверяет токен
3. При успешной авторизации сервер отправляет подтверждение подключения:
   ```json
   {
     "status": "connected",
     "user_id": "uuid-пользователя"
   }
   ```
4. При ошибке авторизации сервер отправляет сообщение об ошибке и закрывает соединение:
   ```json
   {
     "error": "Недействительный токен"
   }
   ```

### Обмен сообщениями

#### Отправка сообщения в чат (от клиента)

```json
{
  "text": "Текст сообщения"
}
```

#### Получение сообщения (от сервера)

```json
{
  "type": "message",
  "data": {
    "id": "uuid-сообщения",
    "sender_id": "uuid-отправителя",
    "sender_name": "Имя отправителя",
    "text": "Текст сообщения",
    "timestamp": "2023-06-21T14:30:00.123456",
    "is_read": false
  }
}
```

#### Получение сообщения через глобальный эндпоинт (от сервера)

```json
{
  "type": "message",
  "data": {
    "id": "uuid-сообщения",
    "chat_id": "uuid-чата",
    "sender_id": "uuid-отправителя",
    "sender_name": "Имя отправителя",
    "text": "Текст сообщения",
    "timestamp": "2023-06-21T14:30:00.123456",
    "is_read": false
  }
}
```

#### Получение сообщения об ошибке (от сервера)

```json
{
  "error": "Текст ошибки"
}
```

## Модели данных

### Пользователь

```json
{
  "id": "UUID",
  "email": "email пользователя",
  "name": "имя пользователя"
}
```

### Чат

```json
{
  "id": "UUID",
  "name": "название чата (может быть null для личных чатов)",
  "type": "personal|group",
  "members": [
    {
      "id": "UUID пользователя",
      "email": "email пользователя",
      "name": "имя пользователя"
    },
    ...
  ]
}
```

### Сообщение

```json
{
  "id": "UUID",
  "chat_id": "UUID чата",
  "sender_id": "UUID отправителя",
  "sender": {
    "id": "UUID отправителя",
    "email": "email отправителя",
    "name": "имя отправителя"
  },
  "text": "текст сообщения",
  "timestamp": "дата и время отправки",
  "is_read": "признак прочтения (true/false)"
}
```

## Коды ошибок

- **400 Bad Request** - Неверный запрос или ошибка в данных
- **401 Unauthorized** - Ошибка аутентификации
- **403 Forbidden** - Недостаточно прав для доступа к ресурсу
- **404 Not Found** - Ресурс не найден
- **500 Internal Server Error** - Внутренняя ошибка сервера

## Примеры использования

### Регистрация и авторизация

1. Зарегистрировать нового пользователя:
   ```
   POST /api/v1/auth/register
   {"email": "user@example.com", "name": "Пользователь", "password": "пароль123"}
   ```

2. Получить токен доступа:
   ```
   POST /api/v1/auth/token
   {"email": "user@example.com", "password": "пароль123"}
   ```

### Работа с чатами

1. Создать личный чат с другим пользователем:
   ```
   POST /api/v1/chats/personal
   {"type": "personal", "member_ids": ["uuid-пользователя"]}
   ```

2. Создать групповой чат:
   ```
   POST /api/v1/chats/group
   {"name": "Рабочая группа", "type": "group", "member_ids": ["uuid-1", "uuid-2", "uuid-3"]}
   ```

3. Получить список чатов:
   ```
   GET /api/v1/chats
   ```

### Работа с сообщениями

1. Получить историю чата:
   ```
   GET /api/v1/chats/{uuid-чата}/history?limit=50&offset=0
   ```

2. Отправить сообщение:
   ```
   POST /api/v1/chats/messages
   {"chat_id": "uuid-чата", "text": "Привет, как дела?"}
   ```

3. Отметить сообщение как прочитанное:
   ```
   POST /api/v1/chats/messages/{uuid-сообщения}/read
   ```

### Использование WebSocket

1. Подключиться к чату:
   ```
   ws://your-domain.com/ws/{uuid-чата}?token={jwt-токен}
   ```

2. Отправить сообщение:
   ```
   {"text": "Привет всем!"}
   ``` 